# 这里放的 YAML 共享配置要确保是 Servlet 服务和 Gateway 服务都能识别的，否则会导致 Gateway 启动失败

# Spring Config
spring:
  main:
    # 允许 Bean 定义覆盖,解决多模块场景下的 Bean 冲突
    allow-bean-definition-overriding: true
    # 延迟初始化, 加速应用启动(生产环境可根据实际情况调整)
    lazy-initialization: false
    # 允许循环依赖(建议在代码层面避免循环依赖)
    allow-circular-references: true

  # Redis 数据源配置
  data:
    redis:
      # Redis 主机地址
      host: 127.0.0.1
      # Redis 端口号
      port: 6379
      # Redis 密码, 默认空字符串
      password:
      # Redis 数据库索引, 默认 0
      database: 0
      # Redis 连接超时时间, 单位毫秒
      timeout: 10s
      # Lettuce 连接池配置
      lettuce:
        pool:
          # 最大连接数(建议根据并发量调整,一般为 CPU 核心数的 2-4 倍)
          max-active: 32
          # 最大空闲连接
          max-idle: 16
          # 最小空闲连接(保持一定数量连接池预热)
          min-idle: 8
          # 连接耗尽时最大等待时间
          max-wait: 3000ms
          # 空闲连接检测间隔
          time-between-eviction-runs: 60s
        # 关闭超时
        shutdown-timeout: 200ms

  # 线程配置
  threads:
    # 虚拟线程配置
    virtual:
      # 全局启用启用虚拟线程(JDK 21)
      enabled: true

  # HTTP 客户端配置(基于 Http Interface)
  http:
    client:
      service:
        # 全局配置 (应用于所有组)
        read-timeout: 2s
        connect-timeout: 1s
        # 分组配置 (每个组可以有不同的超时设置)
        group:
          # 平台模块
          refinex-platform:
            # 平台模块的基础 URL，内部调用不走网关
            base-url: http://localhost:8082
            read-timeout: 2s
            connect-timeout: 1s
          # 智能体模块
          refinex-ai:
            # 智能体模块的基础 URL，内部调用不走网关
            base-url: http://localhost:8083
            read-timeout: 2s
            connect-timeout: 1s
          # 知识库模块
          refinex-kb:
            # 知识库模块的基础 URL，内部调用不走网关
            base-url: http://localhost:8084
            read-timeout: 2s
            connect-timeout: 1s

# SaToken Config
sa-token:
  # Token 名称(同时作为 Cookie 和 Header 的键名)
  token-name: Authorization
  # Token 前缀(建议加上 Bearer 前缀, 符合 OAuth2 规范)
  token-prefix: Bearer
  # 是否允许动态设置 token 有效期，默认 true
  dynamic-active-timeout: true
  # 是否允许从请求参数读取 token，默认 true
  is-read-body: true
  # Token 有效期, 单位：秒, 默认 30 天, -1 代表永久有效
  # Token 有效期(秒), 建议 2 小时, 通过刷新机制延长
  timeout: 7200
  # 最小活跃间隔(秒), 超过此时间未活跃则 Token 失效, 默认 -1 表示不限制
  active-timeout: 3600
  # 是否允许同一账号多端登录, true：允许一起登录, false：新登录挤掉旧登录
  is-concurrent: true
  # 多端登录是否共享同一 Token(建议 false, 提高安全性)
  is-share: false
  # Token 风格 (可选值：uuid(性能好)、simple-uuid、random-32、random-64、random-128、tik、jwt-simple(便于携带信息))
  token-style: uuid
  # 是否输出操作日志(生产环境建议关闭)
  is-log: false
  # 是否尝试从 Cookie 中读取 Token
  is-read-cookie: false
  # 是否尝试从 Header 中读取 Token
  is-read-header: true
  # 是否在登录后将 Token 写入 Cookie
  is-write-header: true
  # 同 Token 检查(用于微服务网关鉴权)
  check-same-token: true
  # Token 续期配置, 单位秒, 默认 -1 表示不限制
  token-session-timeout: -1
  # 自动续签(每次访问自动续期)
  auto-renew: true

# Redisson Config
redisson:
  # 统一键前缀, 避免多应用共用 Redis 时的键冲突
  key-prefix: "refinex:"
  # Redisson 线程池配置(建议为 CPU 核心数)
  threads: 8
  # Netty 线程数(建议为 CPU 核心数的 2 倍)
  netty-threads: 16
  # 编解码器(建议使用 Kryo 或 FST, 性能优于 JDK 序列化)
  codec: org.redisson.codec.Kryo5Codec
  # 单节点配置
  single-server-config:
    # 客户端名称
    client-name: ${spring.application.name}
    # 连接池大小(建议根据并发量调整)
    connection-pool-size: 64
    # 最小空闲连接数
    connection-minimum-idle-size: 16
    # 空闲连接超时(毫秒)
    idle-connection-timeout: 10000
    # 命令执行超时(毫秒)
    timeout: 3000
    # 连接超时(毫秒)
    connect-timeout: 3000
    # 命令重试次数
    retry-attempts: 3
    # 命令重试间隔(毫秒)
    retry-interval: 1500
    # 订阅连接池大小
    subscription-connection-pool-size: 50
    # 订阅连接最小空闲数
    subscription-connection-minimum-idle-size: 1
    # DNS 监控间隔(毫秒)
    dns-monitoring-interval: 5000

# Lock4J Config
lock4j:
  # 获取锁超时时间(毫秒)
  acquire-timeout: 3000
  # 锁过期时间(毫秒), 防止死锁
  expire: 30000

# Refinex Config
refinex:
  # Redis 配置
  redis:
    # redis scan 一次返回数量, 默认 30
    redis-scan-batch-size: 30

  # AES 加密密钥: Base64 编码后的 32 字节密钥
  aes-key: "0umyw3k+P/MSrZ3FhSR81ICJzHRR7PJj8XaqH45QlkE="
  # HMAC 密钥: Base64 编码后的 32 字节密钥
  hmac-key: "X4SCliHw1oFtAhYUeHPiRqNWn8SgiJC4D03my1uoeLA="