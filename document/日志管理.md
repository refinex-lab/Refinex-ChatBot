# 日志管理

## DataSign + TraceId 传递链路

1. 前端请求携带 `DataSign`(UUID)。若缺省, 网关 `TraceContextWebFilter` 自动补充, 同时生成 `X-Trace-Id`。
2. 网关将两个头透传到微服务, 响应头也会回写, 方便客户端排查。
3. 各微服务 Servlet 入口的 `TraceLoggingFilter` 会:
   - 缓存请求/响应体供 `@RequestLog` 使用。
   - 将 DataSign/TraceId 写入 `MDC`, 记录统一的请求开始/结束日志。
   - 将值注入 `TraceContextHolder`, 供业务和 RestClient 访问。
4. `TracePropagationRequestInterceptor` 注入 Spring HTTP Interface, 自动把当前 TraceId/DataSign 向下游服务透传。

## Logback

每个微服务都新增 `logback-spring.xml`, 统一输出格式:

```
%date [%thread] %-5level trace=%X{traceId} dataSign=%X{dataSign} %logger{50}:%line - %msg
```

- `${refinex.logging.log-root}/${spring.application.name}` 作为日志目录。
- `info.log` 保存 INFO/WARN/DEBUG, `error.log` 专存 ERROR。
- `refinex.logging.rolling.*` 控制滚动策略。

## 配置案例

`application.yml` 增加:

```yaml
refinex:
  logging:
  # 全局日志根目录
  log-root: ./logs
  # DataSign / TraceId 头配置
  data-sign-header: DataSign
  trace-id-header: X-Trace-Id
  # 滚动策略
  rolling:
    # 最大文件大小
    max-file-size: 128MB
    # 最大历史文件数
    max-history: 30
    # 总容量上限
    total-size-cap: 10GB
  # 请求日志配置
  request-log:
    # 是否开启请求日志记录
    enabled: true
    # 是否将请求日志持久化到文件
    persist: true
    # 是否记录请求体
    record-request-body: true
    # 是否记录响应体
    record-response-body: false
    # 记录体最大长度
    body-max-length: 4096
    # 忽略路径(不记录日志)
    ignore-paths:
      - /actuator/**
      - /swagger-ui/**
    # 敏感字段(在日志中替换为掩码)
    sensitive-fields:
      - password
      - oldPassword
      - newPassword
      - confirmPassword
      - token
      - mobile
```

## 请求日志注解

`refinex-common/refinex-core` 提供 `@RequestLog`:

```java
@RequestLog(title = "创建知识库", type = RequestLogType.CREATE)
@PostMapping("/kb")
public ApiResponse<Long> create(@RequestBody KbCreateRequest payload) {
    return ApiResponse.success(kbService.create(payload));
}
```

- `recordRequestBody/recordResponseBody` 可按方法细粒度控制。
- 默认通过 `Slf4jRequestLogHandler` 写 info 日志, 若应用存在 `NamedParameterJdbcTemplate` 且 `persist=true`, 则使用 `JdbcRequestLogHandler` 写入 `sys_request_log`。
- 读取请求体依赖 `TraceLoggingFilter` 预先缓存, 无需额外处理。

## 数据库

`document/sql/mysql/table.sql` 提供 `sys_request_log`:

- 重点字段: `data_sign`, `trace_id`, `service_name`, `biz_type`, `duration_ms`。
- `data_sign` / `trace_id` 上均建立索引, 方便从 info.log -> traceId -> DB 全链路检索。

## 排查步骤

1. 前端保留 `DataSign`, 出现问题时在 `info.log` 搜索 `dataSign=<value>` 找到入口日志, 获得 `traceId`。
2. 用 `traceId` 继续在 info/error 日志中检索, 或通过 `sys_request_log.trace_id` 查询详细上下文。
3. 若链路跨微服务, 各服务的日志/数据库都会包含同一个 `traceId`。
